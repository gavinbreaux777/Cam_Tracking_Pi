<!DOCTYPE html>
<html>
    <head>
        <title>Really Cool Thing E's</title>
        <link rel="stylesheet" href="/static/css/styles.css">
    </head>

    <body>
        <h1 style="justify-content: center; text-align: center;">Mitski Killer</h1>
        <div class="grid-container">
            <!--Tabs-->
            <div class="top-strip" >
                <div class="tab-buttons">
                    <button class="active" onclick="openTab(event, 'home')">Home</button>
                    <button onclick="openTab(event, 'motor_control')">Motor Control</button>
                    <button onclick="openTab(event, 'side_by_side')">Side by Side</button>
                    <button onclick="openTab(event, 'calibration')">Calibration</button>
                    <button onclick="openTab(event, 'settings')">Settings</button>
                </div>
            </div>
            <!--Stream image-->
            <div class="tabcontent active center-page" data-tabs="home,motor_control">
                <img id="stream_img" src="/stream" onclick="(forceDetection(event, this.width, this.height))" style="cursor: crosshair; margin: auto;"/>
            </div>
            <!--Base and stream images-->
            <div class="tabcontent center-page" data-tabs="side_by_side">
                <div class="two-img-grid">
                    <img src="/stream" style="grid-column: 1;"/>
                    <img id="base-img" src="/base-img?cache_buster=0" style="grid-column: 2;"/>
                </div>
            </div>
            <!--Stepper Control-->
            <div class="tabcontent bottom-center bottom-style active" data-tabs="motor_control,calibration">
                <div id="stepper-control" class="mot-control-grid">
                    <div id="stepper-control-title" class="mot-ctrl-item" data-item="title" style="text-align: center; font-size: 20px; font-weight: bold;">
                        Stepper Control
                    </div>
                    <div class="mot-control-button-container mot-ctrl-item" data-item="up">
                        <button class="mot-control-button" onmousedown="startJog('up', document.getElementById('speedInput').value)" onmouseup="stopAimMotors()">Up</button>
                    </div>
                    <div class="mot-control-button-container mot-ctrl-item" data-item="down">
                        <button class="mot-control-button" onmousedown="startJog('down', document.getElementById('speedInput').value)" onmouseup="stopAimMotors()">Down</button>
                    </div>
                    <div class="mot-control-button-container mot-ctrl-item" data-item="left">
                        <button class="mot-control-button" onmousedown="startJog('left', document.getElementById('speedInput').value)" onmouseup="stopAimMotors()">Left</button>
                    </div>
                    <div class="mot-control-button-container mot-ctrl-item" data-item="right">
                        <button class="mot-control-button" onmousedown="startJog('right', document.getElementById('speedInput').value)" onmouseup="stopAimMotors()">Right</button>
                    </div>
                    <div class="mot-control-button-container mot-ctrl-item" data-item="center">
                        <label for="speedInput" style="margin-right: 10px;">Jog Speed</label>
                        <input type="text" id="speedInput" value="10" style="width: 50%;">
                    </div>
                    
                    <div class="mot-ctrl-item" data-item="cur-pos" style="display: flex; flex-direction: column; white-space: nowrap; align-self: center;">
                        <div style="display: flex; flex-direction: row; margin-left: 2%">
                            <span>Pan Position:</span>
                            <Span id="x_stepper_pos" style="margin-left: 1%;"></Span>
                        </div>
                        <div style="display: flex; flex-direction: row; margin-left: 2%">
                            <span>Tilt Position:</span>
                            <Span id="y_stepper_pos" style="margin-left: 1%;"></Span>
                        </div>
                    </div>
                    <div class="mot-control-button-container">
                        <button class=" mot-ctrl-item" data-item="more-btn" data-action="toggle-extra">
                            Show More
                        </button>
                    </div>
                    <div class="mot-ctrl-item" data-item="extra" style="display: flex;">
                        <div class="flex-col" style="display: flex; flex-direction: column; margin-right: 2rem;">
                            <input type="checkbox" id="enableXCheckbox" checked onchange="enableDisableMotor('Pan', this.checked)">
                            <label for="enableXCheckbox">Enable Pan</label>
                            <br>
                            <input type="checkbox" id="enableYCheckbox" checked onchange="enableDisableMotor('Tilt', this.checked)">
                            <label for="enableYCheckbox">Enable Tilt</label>
                        </div>
                        <div class="flex-col no-wrap">
                            <div>
                                Tilt Homing / Limits
                            </div>
                            <div class="flex-row">
                                <div class="flex-col">
                                    <button class="mot-ctrl-item no-wrap" data-action="set-home">
                                        Set Home
                                    </button>
                                </div>
                                <div class="flex-col align-start no-wrap">
                                    <div class="flex-row">
                                        <div class="btn-disabled-wrapper" data-tooltip="Motor home must be set first">
                                            <button class="mot-ctrl-item" data-action="set-upper" disabled>
                                                Set Upper
                                            </button>
                                        </div>                                        
                                        <div id="tilt-upper-limit">
                                            -
                                        </div>
                                    </div>
                                    <div class="flex-row">
                                        <div class="btn-disabled-wrapper" data-tooltip="Motor home must be set first">
                                            <button class="mot-ctrl-item" data-action="set-lower" disabled>
                                                Set Lower
                                            </button>
                                        </div>                                            
                                        <div id="tilt-lower-limit">
                                            -
                                        </div>
                                    </div>
                                </div>
                                <button class="mot-ctrl-item" data-action="reset-limits">
                                    Reset Limits
                                </button>
                            </div>          
                            <div class="btn-disabled-wrapper full-width-centered" data-tooltip="Motor home must be set first">
                                <button class="mot-ctrl-item" data-action="move-home" disabled>
                                    Move Home
                                </button>
                            </div>
                        </div>                        
                    </div>
                </div>
            </div>
            <!--Servo Control-->
            <div class="tabcontent bottom-right bottom-style" data-tabs="motor_control">
                <div id="servo-control" class="servo-control-grid">
                    <div id="servo-control-title" style="grid-row: 1; grid-column: 1/3;
                    text-align: center; font-size: 20px; font-weight: bold;">
                        Servo Control
                    </div>
                    <div class="mot-control-button-container" style="grid-row: 2; grid-column: 1; display: flex; flex-direction: column; text-align: center;">
                        <div>Current Position</div>
                        <div id="servo-pos">0</div>
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.25rem; justify-content: center;">
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <button onclick="teachServo('open')">Teach Open</button>
                                <span id="taughtOpenVal" style="margin-top: 4px; font-size: 12px;">—</span>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <button onclick="teachServo('closed')">Teach Closed</button>
                                <span id="taughtClosedVal" style="margin-top: 4px; font-size: 12px;">—</span>
                            </div>
                        </div>
                    </div>
                    <div class="mot-control-button-container" style="grid-row: 2; grid-column: 2; display: flex; flex-direction: column; text-align: center;">
                        <div style="display: flex; flex-direction: row; align-items: center; gap: 2rem;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">                 
                                <button style="padding: 0.5rem;" onclick="openChamberServo()">Open Servo</button>               
                                <button style="padding: 0.5rem;" onclick="closeChamberServo()">Close Servo</button>                                
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                                <button onclick="moveChamberServo(document.getElementById('positionInput').value)">Move To Target</button>
                                <div style="display: flex; flex-direction: row">
                                    <label for="positionInput" style="margin-right: 10px; font-size: 14px;">Target<br> Degrees</label>
                                    <input type="text" id="positionInput" value="10" style="width: 3rem; text-align: center; height: 1.5rem;">  
                                </div>                                
                            </div>   
                        </div>                                           
                    </div>
                </div>
            </div>
            <!--DC Motor Control-->
            <div class="tabcontent bottom-left bottom-style" data-tabs="motor_control">
                <div id="dc-motor-control" style="display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
                    <div id="dc-motor-control-title" style="text-align: center; font-size: 20px; font-weight: bold;">
                        DC Motor Control
                    </div>
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px; flex-grow: 1;">
                        <div style="display: flex; flex-direction: row; align-items: center; gap: 10px; margin: 5px;">
                            <div>Enable Motors</div>
                            <input type="checkbox" id="enableDCMotorsCheckbox" checked onchange="enableDisableMotor('Spool', this.checked)" style="vertical-align: center;">
                        </div>
                        <div style="display: flex; justify-content: center; align-items: center;">
                            <button style="padding: 10%" onmousedown="spoolID = setInterval(spoolDCMotors, 50)" 
                                    onmouseup="clearInterval(spoolID); stopSpoolingDCMotors()">
                                Spool Motors
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!--Calibration-->
            <div class="tabcontent center-page" data-tabs="calibration">
                <div class="two-img-grid">
                    <div class="click-img-wrapper">
                        <img id="stream_img" src="/stream" onclick="(calibration.saveLocation(event, this.width, this.height))" class="clb-stream-img"/>
                    </div>                    
                    <div id="img_div_two" class="save-clb-stack">
                        Click in the image to save coordinates
                    </div>
                </div>
            </div>
            <!--Calibration data-->
            <div class="tabcontent bottom-left" data-tabs="calibration">
                <div style="text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 10%;">Calibration Data</div>
                <div style="display: flex; flex-direction: row; margin-bottom: 5%; white-space: nowrap; justify-content: center;">
                    <span>X Degrees / %Move:</span>
                    <span id="x_degrees_per" Style="border-bottom: rgba(245, 245, 245, 0.565) 2px solid; margin-left: 3%;"></span>
                </div>
                <div style="display: flex; flex-direction: row; white-space: nowrap; justify-content: center;">
                    <span>Y Degrees / %Move:</span>
                    <span id="y_degrees_per" Style="border-bottom: rgba(245, 245, 245, 0.565) 2px solid; margin-left: 3%;"></span>
                </div>
            </div>
            <!--Settings tab-->
            <div class="tabcontent center-page" data-tabs="settings">
                
            </div>
            <!--Settings right strip-->
            <div class="right-strip">
                    <label for="objSizeInput">Required Object Size</label>
                    <input oninput="changeImgProcSetting('requiredObjectSize', this.value)" id="objSizeInput" type="number" value="10000" style="width: 50%;"/>
                    <label for="gainInput" style="display:block; margin-top: 10">Analogue Gain</label>
                    <input oninput="changeCamSetting('AnalogueGain', this.value)" id="gainInput" type="number" value="10.0" style="width: 50%;"/>
            </div>
            <!--Run Control-->
            <div class="left-strip">
                <button onclick="stopImgMod()" id="start_stop_img_mod" class="run-btn-style">
                    Run Detection
                </button>
                <button onclick="stopStream()" id="start_stop_stream" class="run-btn-style">
                    Stop Stream
                </button>
                <button onclick="actOnDetection()" id="toggle_act_on_detection" class="run-btn-style">
                    Enable Act On Detection
                </button>
                <input id="show_delta" type="checkbox" onclick="toggleDelta(this.checked)">
                <label for="show_delta">Show Delta</label>
                <br>
                <input id="show_contours" type="checkbox" onclick="toggleContours(this.checked)">
                <label for="show_contours">Show Contours</label>
            </div>
            <!--Non-Tabs-->
            <!--Detect Image-->
            <img id="detect_img" onclick="hideDetectImg()" style="display: none"/>
            <!--Working calibration data--
            Note that data-tabs is present but empty - this is so we can show things dynamically using js but switching tabs will still clear it all-->
            <div id="working_calibration_data" class="tabcontent bottom-right" data-tabs="">
                <!--To be shown when image is clicked-->
                <div style="text-align: center; font-weight: bold; margin-bottom: 3%;">Working Calibration Data</div>
                <div style="display: flex; flex-direction: row; white-space: nowrap; justify-content: center;">
                    <span>X Click Ratio:</span>
                    <span id="xClickRatio" style="margin-left: 3%;"></span>
                </div>
                <div style="display: flex; flex-direction: row; white-space: nowrap; justify-content: center;">
                    <span>Y Click Ratio:</span>
                    <span id="yClickRatio" style="margin-left: 3%;"></span>
                </div>
                <div style="display: flex; flex-direction: row; white-space: nowrap; justify-content: center;">
                    <span>Motor Calibration Start X:</span>
                    <span id="motorCalibrationStartX" style="margin-left: 3%;"></span>
                </div>
                <div style="display: flex; flex-direction: row; white-space: nowrap; justify-content: center;">
                    <span>Motor Calibration Start Y:</span>
                    <span id="motorCalibrationStartY" style="margin-left: 3%;"></span>
                </div>
                <!--To be shown after save calibration button press-->
                <div id="post_save_calibration_data" class="tabcontent" data-tabs="">
                    <div style="display: flex; flex-direction: row; white-space: nowrap; justify-content: center;">
                        <span>Motor Delta X:</span>
                        <span id="motor_delta_x" style="margin-left: 3%;"></span>
                    </div>
                    <div style="display: flex; flex-direction: row; white-space: nowrap; justify-content: center;">
                        <span>Motor Delta Y:</span>
                        <span id="motor_delta_y" style="margin-left: 3%;"></span>
                    </div>
                </div>
            </div>
        </div>
        <script type="module" src="/static/js/App.js"></script>
        <script src="/static/js/cameraControl.js"></script>
        <script src="/static/js/motorControl.js"></script>
        <script src="/static/js/uiComponents.js"></script>
        <script src="/static/js/calibration.js"></script>

        
    </body>
</html>
