<html>
    <head>
        <title>Really Cool Thing E's</title>
        <style>
            .grid-container {
                display: grid;
                height: 90vh;
                grid-template-columns: 10% 1fr 1fr 1fr 1fr 10%;
                grid-template-rows: 5% 1fr 1fr 1fr 1fr 1fr 20%;
                grid-gap: 10px; 
                padding: 10px;
                border: 2px solid green;
                place-items: center;
            }
            .grid-item{
                margin: 0px;
            }
            .btn-style{
                margin: 0 auto 10%; width: 100%; height: auto; font-size: 12;
            }
            .mot-control-grid{
                display: grid;
                height: 100%;
                width: 100%;
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: 15% 1fr 1fr 1fr;
                border: 5px solid purple;
            }
            .mot-control-button{
                height: 100%;
                width: 100%;
            }
            .mot-control-button-container{
                display: flex; 
                justify-content: center; 
                align-items: center;
                border: 2px dashed orange;
            }
            .servo-control-grid{
                display: grid;
                height: 100%;
                width: 100%;
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: 1fr 1fr 1fr 1fr 1fr;
                border: 5px solid gray
            }
            .two-img-grid{
                display: grid;
                height: 100%;
                width: 100%;
                grid-template-columns: 1fr 1fr;
                border: 5px solid green;
            }
        </style>
    </head>

    <body style="background-color: darkGray;">
        <h1 style="justify-content: center; text-align: center;">Cool Shit</h1>
        <div class="grid-container">
            <div id="left_strip" class="grid-item" style="grid-row: 2; grid-column: 1; border-style: dotted; border-color: green;">
                <button onclick="stopImgMod()" id="start_stop_img_mod" class="btn-style">
                    Run Detection
                </button>
                <button onclick="stopStream()" id="start_stop_stream" class="btn-style">
                    Stop Stream
                </button>
                <button onclick="actOnDetection()" id="toggle_act_on_detection" class="btn-style">
                    Enable Act On Detection
                </button>
                <input id="show_delta" type="checkbox" onclick="toggleDelta(this.checked)">
                <label for="show_delta">Show Delta</label>
                <br>
                <input id="show_contours" type="checkbox" onclick="toggleContours(this.checked)">
                <label for="show_contours">Show Contours</label>
            </div>
            <div id="center_page" class="grid-item" style="grid-row: 2 / 7; grid-column: 2 / 6;  border: 5px dotted red; height: auto; width: 100%">
            </div>
            <div id="top_strip" class="grid-item" style="grid-row: 1; grid-column: 2 / 6; border: 6px dashed burlywood; height: 100%; width: 100%; display: flex; flex-direction: row;">
                <div style="border: 5px dashed cyan;">
                    <button onclick="toggleMainPage()" id="main_page_btn" class="btn-style" >
                    Main Page
                    </button>
                </div>
                <div style="border: 5px dashed blue;">
                    <button onclick="toggleMotControl()" id="mot_ctrl_btn" class="btn-style" >
                    Motor Control
                    </button>
                </div>
                <div style="border: 5px solid magenta;">
                    <button onclick="toggleStreamAndBaseImg()" id="show_base_img_btn" class="btn-style" >
                        Show Base Image
                    </button>
                </div>
                <div style="border: 5px dotted darkorange">
                    <button onclick="toggleCalibration()" id="toggle_calibration" class="btn-style">
                        Calibrate Motors
                    </button>
                </div>
            </div>
            
            
            <div id="bottom-center-section" style="grid-row: 7; grid-column: 3 / 5; height: 100%; width: 100%"></div>
            <div id="bottom-right-section" style="grid-row: 7; grid-column: 5 / 7; height: 100%; width: 100%;"></div>
            <div id="bottom-left-section" style="grid-row: 7; grid-column: 1 / 3; height: 100%; width: 100%;"></div>
            <div id="right-strip" style="grid-row: 2 / 5; grid-column: 6; border: 5px solid pink; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center;">
                <div style="border: 2px dashed black;">
                    <label for="objSizeInput">Required Object Size</label>
                    <input oninput="changeImgProcSetting('requiredObjectSize', this.value)" id="objSizeInput" type="number" value="10000" style="width: 50%;"/>
                    <label for="gainInput" style="display:block; margin-top: 10">Analogue Gain</label>
                    <input oninput="changeCamSetting('AnalogueGain', this.value)" id="gainInput" type="number" value="10.0" style="width: 50%;"/>
                </div>
            </div>
        </div>

        </div>
        
        <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script>
            const pageSections = {
                center: document.getElementById("center_page"),
                bottomCenter: document.getElementById("bottom-center-section"),
                bottomRight: document.getElementById("bottom-right-section"),
                bottomLeft: document.getElementById("bottom-left-section"),
                leftStrip: null,
                rightStrip: null,
                topStrip: null
            }
            const pageButtons = {
                imageModButton: document.getElementById("start_stop_img_mod"),
                streamButton: document.getElementById("start_stop_stream"),
                actOnDetectionButton: document.getElementById("toggle_act_on_detection")
            }
            const serverData = {
                xStepperPosition: 0,
                yStepperPosition: 0,
                servoPosition: 0,
                actOnDetection: 0,
                runMode: 0
            }

        //HTML dynamic components
            class ImageFactory{
                constructor(){}

                static createStreamImage(htmlElementToAppendTo){
                    //create image element
                    const img = document.createElement('img');
                    img.src = '/stream';
                    img.id = 'stream_img';
                    img.style.display = 'block';
                    img.style.margin = '0 auto';
                    img.style.maxHeight = '100%'
                    img.style.maxWidth = '100%'
                    img.style.borderwidth = '2';
                    img.style.borderColor = 'black';
                    img.style.borderstyle = 'solid';

                    //clear the specified element and append the image
                    htmlElementToAppendTo.innerHTML = ""
                    htmlElementToAppendTo.appendChild(img)
                }

                static createBaseImg(htmlElementToAppendTo){
                    const img = document.createElement('img');
                    img.src = '/base-img?cache_buster=' + new Date().getTime();
                    img.id = 'base_img';
                    img.style.display = 'block';
                    img.style.margin = '0 auto';
                    img.style.maxHeight = '100%'
                    img.style.maxWidth = '100%'
                    img.style.borderWidth = '2';
                    img.style.borderColor = 'blue';
                    img.style.borderstyle = 'solid';

                    //clear the specified element and append the image
                    htmlElementToAppendTo.innerHTML = "";
                    htmlElementToAppendTo.appendChild(img);
                }

                static appendImage(htmlElementToAppendTo, src){
                    //create image element
                    const img = document.createElement('img');
                    img.src = src;
                    img.id = 'stream_img';
                    img.style.display = 'block';
                    img.style.margin = '0 auto';
                    img.style.maxHeight = '100%'
                    img.style.maxWidth = '100%'
                    img.style.borderwidth = '2';
                    img.style.borderColor = 'black';
                    img.style.borderstyle = 'solid';

                    //clear the specified element and append the image
                    htmlElementToAppendTo.innerHTML = "";
                    htmlElementToAppendTo.appendChild(img);

                    return img;
                }

                static createDetectedImage(htmlElementToAppendTo){
                    const img = document.createElement('img');
                    img.src = '/detect-img?cache_buster=' + new Date().getTime();
                    img.id = 'detect_img';
                    img.style.display = 'block';
                    img.style.margin = '0 auto';
                    img.style.maxHeight = '100%'
                    img.style.maxWidth = '100%'
                    img.style.borderWidth = '2';
                    img.style.borderColor = 'blue';
                    img.style.borderstyle = 'solid';

                    //clear the specified element and append the image
                    htmlElementToAppendTo.innerHTML = "";
                    htmlElementToAppendTo.appendChild(img);
                }

                static createStreamAndBaseImage(htmlElementToAppendTo){
                    const container = document.createElement('div');
                    container.className = 'two-img-grid';

                    //Create live stream image
                    const streamContainer = document.createElement('div');
                    streamContainer.id = "img_div_one"
                    streamContainer.className = 'mot-control-button-container'
                    streamContainer.style.gridColumn = '1';
                    streamContainer.style.width = '100%';
                    this.createStreamImage(streamContainer)
                    //appendImage(streamContainer, '/stream'); //This works when tied directly to navigation buttons but not here

                    container.appendChild(streamContainer);

                    //Create static base image
                    const baseImgContainer = document.createElement('div');
                    baseImgContainer.id = "img_div_two"
                    baseImgContainer.className = 'mot-control-button-container'
                    baseImgContainer.style.gridColumn = '2';
                    baseImgContainer.style.height = '100%';
                    this.createBaseImg(baseImgContainer)
                    //appendImage(streamContainer, '/base-img?cache_buster=' + new Date().getTime());

                    container.appendChild(baseImgContainer);

                    htmlElementToAppendTo.innerHTML = "";
                    htmlElementToAppendTo.appendChild(container);
                }

            }

            class StepperControl{
                constructor(){
                    this.items = {
                        jogSpeedElement: null
                    }
                }

                createGrid(htmlElementToAppendTo){
                    //grid container for all buttons
                    const container = document.createElement('div')
                    container.className = 'mot-control-grid'

                    //Title
                    const titleContainer = document.createElement('div');
                    titleContainer.style.gridRow = '1';
                    titleContainer.style.gridColumn = '1 / 5';
                    titleContainer.style.textAlign = 'center';
                    titleContainer.textContent = "Stepper Control";
                    titleContainer.style.margin = '5px';

                    //up button
                    const upcontainer = document.createElement('div');
                    upcontainer.className = 'mot-control-button-container';
                    upcontainer.style.gridRow = '2';
                    upcontainer.style.gridColumn = '2';
                    
                    const upButton = document.createElement('button');
                    upButton.className = 'mot-control-button';
                    upButton.onmousedown = () => startJog('up', this.items.jogSpeedElement.value);
                    upButton.onmouseup = stopMotors;
                    upButton.textContent = 'up button';
                    
                    upcontainer.appendChild(upButton);

                    //down button
                    const downContainer = document.createElement('div');
                    downContainer.className = 'mot-control-button-container';
                    downContainer.style.gridRow = '4';
                    downContainer.style.gridColumn = '2';
                    
                    const downButton = document.createElement('button');
                    downButton.className = 'mot-control-button';
                    downButton.onmousedown = () => startJog('down', this.items.jogSpeedElement.value);
                    downButton.onmouseup = stopMotors;
                    downButton.textContent = 'down button';
                    
                    downContainer.appendChild(downButton);

                    //left button
                    const leftContainer = document.createElement('div');
                    leftContainer.className = 'mot-control-button-container';
                    leftContainer.style.gridRow = '3';
                    leftContainer.style.gridColumn = '1';
                    
                    const leftButton = document.createElement('button');
                    leftButton.className = 'mot-control-button';
                    leftButton.onmousedown = () => startJog('left', this.items.jogSpeedElement.value);
                    leftButton.onmouseup = stopMotors;
                    leftButton.textContent = 'left button';
                    
                    leftContainer.appendChild(leftButton);

                    //right button
                    const rightContainer = document.createElement('div');
                    rightContainer.className = 'mot-control-button-container';
                    rightContainer.style.gridRow = '3';
                    rightContainer.style.gridColumn = '3';
                    
                    const rightButton = document.createElement('button');
                    rightButton.className = 'mot-control-button';
                    rightButton.onmousedown = () => startJog('right', this.items.jogSpeedElement.value);
                    rightButton.onmouseup = stopMotors;
                    rightButton.textContent = 'right button';
                    
                    rightContainer.appendChild(rightButton);

                    //speed setting box
                    const speedContainer = document.createElement('div');
                    speedContainer.style.gridRow = '3';
                    speedContainer.style.gridColumn = '2';
                    speedContainer.style.display = 'flex';
                    speedContainer.style.justifyContent = 'center';
                    speedContainer.style.alignItems = 'center';
                    
                    const label = document.createElement('label');
                    label.setAttribute('for', 'speedInput');
                    label.style.marginRight = '10px';
                    label.textContent = 'Jog Speed';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = 'speedInput';
                    input.style.width = '50%';
                    input.value = "10";
                    this.items.jogSpeedElement = input;
                    
                    speedContainer.appendChild(label);
                    speedContainer.appendChild(input);

                    //Enable/disable motors
                    const enableMotorsContainer = document.createElement('div');
                    enableMotorsContainer.style.gridRow = '4';
                    enableMotorsContainer.style.gridColumn = '1';

                    const enableXCheckbox = document.createElement('input');
                    enableXCheckbox.type = 'checkbox';
                    enableXCheckbox.id = 'enableXCheckbox';
                    enableXCheckbox.checked = true;
                    enableXCheckbox.addEventListener('change', function(){ enableDisableMotor('x', this.checked) });
                    enableMotorsContainer.appendChild(enableXCheckbox);

                    const enableXLabel = document.createElement('label');
                    enableXLabel.setAttribute('for', 'enableXCheckbox');
                    enableXLabel.textContent = 'Enable X';
                    enableMotorsContainer.appendChild(enableXLabel);

                    const lineBreak = document.createElement('br');
                    enableMotorsContainer.appendChild(lineBreak);
                    
                    const enableYCheckbox = document.createElement('input');
                    enableYCheckbox.type = 'checkbox';
                    enableYCheckbox.id = 'enableYCheckbox';
                    enableYCheckbox.checked = true;
                    enableYCheckbox.addEventListener('change', function(){ enableDisableMotor('y', this.checked) });
                    enableMotorsContainer.appendChild(enableYCheckbox);

                    const enableYLabel = document.createElement('label');
                    enableYLabel.setAttribute('for', 'enableYCheckbox');
                    enableYLabel.textContent = 'Enable Y';
                    enableMotorsContainer.appendChild(enableYLabel);

                    //combine everything
                    container.appendChild(titleContainer)
                    container.appendChild(upcontainer)
                    container.appendChild(downContainer)
                    container.appendChild(leftContainer)
                    container.appendChild(rightContainer)
                    container.appendChild(speedContainer)
                    container.appendChild(enableMotorsContainer)

                    //clear the specified element
                    htmlElementToAppendTo.innerHTML = ""

                    //append to specified element
                    htmlElementToAppendTo.appendChild(container)
                }
            }     

            class ServoControl{

                constructor(){
                    this.items = {
                        targetPositionElement: null,
                        currentPositionElement: null
                    }
                }

                updateData(){
                    this.items.currentPositionElement.textContent = serverData.servoPosition;
                }

                createGrid(htmlElementToAppendTo){
                    //grid container for all buttons
                    const container = document.createElement('div')
                    container.className = 'servo-control-grid'

                    //title
                    const titleContainer = document.createElement('div');
                    titleContainer.style.gridRow = '1';
                    titleContainer.style.gridColumn = '1 / 5'
                    titleContainer.style.textAlign = 'center';
                    titleContainer.textContent = "Servo Control";
                    titleContainer.style.margin = '5px';

                    container.appendChild(titleContainer);

                    //Current position
                    const leftContainer = document.createElement('div');
                    leftContainer.style.display = 'flex';
                    leftContainer.style.flexDirection = 'column';
                    leftContainer.style.textAlign = 'center';
                    leftContainer.style.justifyItems = 'center';
                    leftContainer.style.alignItems = 'center';
                    leftContainer.className = 'mot-control-button-container';
                    leftContainer.style.gridRow = '2 / 6';
                    leftContainer.style.gridColumn = '1 / 2';
                    
                    const currentPosTitle = document.createElement('div');
                    currentPosTitle.textContent = 'Current Position';
                    leftContainer.appendChild(currentPosTitle);

                    const currentPosValue = document.createElement('div');
                    this.items.currentPositionElement = currentPosValue
                    currentPosValue.id = "servo-pos";
                    currentPosValue.textContent = serverData.xStepperPosition;
                    
                    leftContainer.appendChild(currentPosValue);
                    

                    // Target Position
                    const targetPositionContainer = document.createElement('div');
                    targetPositionContainer.className = 'mot-control-button-container';
                    targetPositionContainer.style.gridRow = '2 / 6';
                    targetPositionContainer.style.gridColumn = '2 / 5';
                    targetPositionContainer.style.display = 'flex';
                    targetPositionContainer.style.flexDirection = 'column';
                    targetPositionContainer.style.textAlign = 'center';
                    targetPositionContainer.style.justifyItems = 'center';
                    targetPositionContainer.style.alignItems = 'center';
                    
                    const moveBtn = document.createElement('button')
                    moveBtn.style.width = '50%';
                    moveBtn.style.height = '100%';
                    moveBtn.textContent = 'Move To Target';

                    targetPositionContainer.appendChild(moveBtn);
                    
                    const label = document.createElement('label');
                    label.setAttribute('for', 'positionInput');
                    label.style.marginRight = '10px';
                    label.textContent = 'Target Position';
                    label.style.marginTop = '5px';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = 'positionInput';
                    input.style.width = '50%';
                    input.value = "10";
                    this.items.targetPositionElement = input

                    moveBtn.onclick = () => {moveServo((this.items.targetPositionElement).value);}
                    
                    targetPositionContainer.appendChild(label);
                    targetPositionContainer.appendChild(input);

                    //combine everything
                    container.appendChild(leftContainer)
                    container.appendChild(targetPositionContainer)

                    //clear the specified element
                    htmlElementToAppendTo.innerHTML = ""

                    //append to specified element
                    htmlElementToAppendTo.appendChild(container)
                }
            }          

            class DcMotorControl{
                createGrid(htmlElementToAppendTo){
                    const container = document.createElement('div');
                    container.style.border = '5px black solid';

                    const title = document.createElement('div')
                    title.style.textAlign = 'center';
                    title.textContent = "Servo Control";
                    title.style.margin = '5px';
                    container.appendChild(title);

                    const enableContainer = document.createElement('div');
                    enableContainer.style.display = 'flex';
                    enableContainer.style.flexDirection = 'row';
                    enableContainer.style.gap = '10px';
                    enableContainer.style.margin = '10px 0px';

                    const enableText = document.createElement('div')
                    enableText.textContent = "Enable Motors";
                    enableContainer.append(enableText);
                    container.append(enableContainer);

                    const enableCB = document.createElement('input');
                    enableCB.type = 'checkbox';
                    enableCB.addEventListener('change', function(){ enableDisableDCMotors(this.checked) });
                    enableContainer.appendChild(enableCB);

                    const spoolButtonContainer = document.createElement('div');
                    spoolButtonContainer.style.display = 'flex';
                    spoolButtonContainer.style.justifyContent = 'center';
                    spoolButtonContainer.style.margin = '20px';

                    const spoolButton = document.createElement('button');
                    spoolButton.style.margin = '2px';
                    spoolButton.textContent = "Spool motors";
                    spoolButton.style.padding = '10px';
                    
                    //Repeatedly send spool requests, server will timeout if request not received in time
                    let spoolInterval;
                    spoolButton.addEventListener('mousedown', () => {
                        spoolDCMotors();
                        spoolInterval = setInterval(spoolDCMotors, 50);
                    });
                    spoolButton.addEventListener('mouseup', () => {
                        clearInterval(spoolInterval);
                        stopSpoolingDCMotors();
                    });
                    spoolButtonContainer.appendChild(spoolButton);
                    container.appendChild(spoolButtonContainer);

                    //clear the specified element
                    htmlElementToAppendTo.innerHTML = ""

                    //append to specified element
                    htmlElementToAppendTo.appendChild(container)
                }
            }

            class Calibration{
                constructor(){
                    this.items = {
                        xClickRatio: null,
                        yClickRatio: null,
                        motorCalibrationStartX: null,
                        motorCalibrationStartY: null,
                        crosshairlength: 50
                    }
                }

                createCalibrationPage(htmlElementToAppendTo){
                    ImageFactory.createStreamAndBaseImage(htmlElementToAppendTo)

                    const imgDivTwo = document.getElementById("img_div_two");
                    imgDivTwo.innerHTML = "";
                    imgDivTwo.innerText = "Click in the image to save coordinates"
                    imgDivTwo.style.fontWeight = "bold"

                    const streamImg = document.getElementById("stream_img");
                    console.log("setting cursor to crosshair" + streamImg);
                    streamImg.style.cursor = "crosshair";
                    streamImg.addEventListener('click', (event) => {
                        this.saveLocation(event, streamImg.width, streamImg.height)
                    });
                }

                saveLocation(clickEvent, imgWidth, imgHeight){
                    this.items.xClickRatio = (clickEvent.offsetX - (imgWidth/2)) / (imgWidth/2);
                    this.items.yClickRatio = ((imgHeight/2) - clickEvent.offsetY) / (imgHeight/2);

                    this.items.motorCalibrationStartX = serverData.xStepperPosition;
                    this.items.motorCalibrationStartY = serverData.yStepperPosition;

                    const saveCalibrationBtn = document.createElement("button");
                    saveCalibrationBtn.textContent = "Save Calibration";
                    saveCalibrationBtn.onclick = () => {
                        this.calculateAndPushCalibration()
                    };

                    const imgDivTwo = document.getElementById("img_div_two");
                    imgDivTwo.innerHTML = "";
                    imgDivTwo.appendChild(saveCalibrationBtn);

                    const streamImg = document.getElementById("stream_img")

                    const clickCanvas = document.createElement('canvas');
                    const ctx = clickCanvas.getContext('2d');
                    clickCanvas.width = streamImg.width;
                    clickCanvas.height = streamImg.height;
                    ctx.drawImage(streamImg, 0, 0, clickCanvas.width, clickCanvas.height);
                    
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 2;
                    this.items.crosshairlength = 50;
                    
                    //draw crosshair on clicked location
                    drawCrosshair(ctx, clickEvent.offsetX, clickEvent.offsetY, this.items.crosshairlength, 'red', 2)

                    const clickImage = new Image();
                    clickImage.src = clickCanvas.toDataURL();

                    clickImage.onload = () => {
                        imgDivTwo.appendChild(clickImage);
                    }
                }

                calculateAndPushCalibration(){
                    const motorXDelta = serverData.xStepperPosition - this.items.motorCalibrationStartX
                    const motorYDelta = serverData.yStepperPosition - this.items.motorCalibrationStartY

                    const xDegreesPerDetectDistanceRatio = motorXDelta / this.items.xClickRatio
                    const yDegreesPerDetectDistanceRatio = motorYDelta / this.items.yClickRatio
                    //Push calibration to server
                    sendMotorCalibrationFactors(xDegreesPerDetectDistanceRatio, yDegreesPerDetectDistanceRatio)
                }
            }

            const imageFactory = new ImageFactory()
            const servoController = new ServoControl() 
            const stepperControl = new StepperControl()
            const dcMotorControl = new DcMotorControl()
            const calibration = new Calibration()


            //Page navigation
            function toggleMotControl(){
                stepperControl.createGrid(pageSections.bottomCenter)
                servoController.createGrid(pageSections.bottomRight)
                dcMotorControl.createGrid(pageSections.bottomLeft)
            }

            function toggleMainPage(){
                //createStreamImage(pageSections.center)
                streamImg = ImageFactory.appendImage(pageSections.center, "/stream")
                streamImg.style.cursor = "crosshair";
                streamImg.addEventListener('click', (event) => {
                        forceDetection(event, streamImg.width, streamImg.height)
                    });
                pageSections.bottomCenter.innerHTML = ""
                pageSections.bottomRight.innerHTML = ""
            }

            function toggleStreamAndBaseImg(){
                ImageFactory.createStreamAndBaseImage(pageSections.center);
            }

            function toggleCalibration(){
                calibration.createCalibrationPage(pageSections.center);
            }

            function displayDetectImg(){
                //ImageFactory.createDetectedImage(pageSections.bottomCenter)
                ImageFactory.appendImage(pageSections.bottomCenter, '/detect-img?cache_buster=' + new Date().getTime());
            }


            //Server requests
            function stopStream(){
                const btn = document.getElementById("start_stop_stream")
                fetch('/stopStream', {
                    method: 'GET'
                    })
                    .then(response => {
                        if (response.status === 200){
                            console.log("Stream stopped. Server response = " + response.body);
                        }
                        else{
                            console.log("Failure to stop stream. Server response: " + response.status);
                        }
                    })
                    .then(data => {
                        //btn.innerHTML = "Start Stream"
                        //btn.onclick = startStream
                    })
                    .catch(error => {
                        console.error(error)
                    })
                }

            function startStream(){
                const btn = document.getElementById("start_stop_stream")
                const stream = document.getElementById("stream_img")
                fetch('/stream',{
                    method: 'GET'
                })
                .then(response => {
                    if (response.status === 200){
                        console.log("Stream started. Server response = " + response.body);
                        
                    }
                    else{
                        console.log("Server failed to start stream. Server response: " + server.response)
                    }
                })
                .then(data => {
                    stream.src = "/stream"
                    //btn.innerHTML = "Stop Stream"
                    //btn.onclick = stopStream
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function stopImgMod(){
                const btn = document.getElementById("start_stop_img_mod")
                fetch('/stopImgMod', {
                    method: 'GET'
                    })
                    .then(response => {
                        if (response.status === 200){
                            console.log("Image mod stopped. Server response = " + response.body);
                        }
                        else{
                            console.log("Failure to stop image mod. Server response: " + response.status);
                        }
                    })
                    .catch(error => {
                        console.error(error)
                    })
                }

            function startImgMod(){
                const btn = document.getElementById("start_stop_img_mod")
                fetch('/startImgMod', {
                    method: 'GET'
                    })
                    .then(response => {
                        if (response.status === 200){
                            console.log("Image mod started. Server response = " + response.body);
                        }
                        else{
                            console.log("Failure to start image mod. Server response: " + response.status);
                        }
                    })
                    .catch(error => {
                        console.error(error)
                    })
                }

            function actOnDetection(){
                const enableStr = !serverData.actOnDetection;
                const btn = document.getElementById("toggle_act_on_detection")
                fetch(`/actOnDetection/${enableStr}`, {
                    method: 'GET'
                    })
                    .then(response => {
                        if (response.status === 200){
                            console.log("Enabled action on detection. Server response = " + response.body);
                        }
                        else{
                            console.log("Failure to enable action on detection. Server response: " + response.status);
                        }
                    })
                    .catch(error => {
                        console.error(error)
                    })
            }

            function startJog(direction, speed){
                console.log("Starting jog")
                fetch(`/motorControl/${direction}/${speed}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server moving motor. Response: " + response.body);
                    }
                    else{
                        console.log("Error while requesting motor move. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function stopMotors(){
                console.log("Stopping motors")
                fetch("/stopMotors",{
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server stopping motor. Response: " + response.body);
                    }
                    else{
                        console.log("Error while requesting motor stop. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }
            
            function moveServo(target){
                console.log("Moving servo");
                fetch(`/moveServo/${target}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server moving servo. Response: " + response.body);
                    }
                    else{
                        console.log("Error while requesting servo move. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function changeImgProcSetting(settingName, settingValue){
                fetch(`/modImgProcSetting/${settingName}/${settingValue}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server is modifying setting. Response: " + response.text());
                    }
                    else{
                        console.log("Error while requesting setting modification. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function changeCamSetting(settingName, settingValue){
                fetch(`/modCamSetting/${settingName}/${settingValue}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server is modifying setting. Response: " + response.text());
                    }
                    else{
                        console.log("Error while requesting setting modification. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function sendMotorCalibrationFactors(xCalibration, yCalibration){
                fetch(`/calibrateMotors/${xCalibration}/${yCalibration}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server is setting calibration factors. Response: " + response.text());
                    }
                    else{
                        console.log("Error while requesting setting modification. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function forceDetection(clickEvent, imgWidth, imgHeight){
                //Calculate percent offset x and y from center )
                const xClickRatio = (clickEvent.offsetX - (imgWidth/2)) / (imgWidth/2);
                const yClickRatio = ((imgHeight/2) - clickEvent.offsetY) / (imgHeight/2);
                console.log("location = " + xClickRatio + ", " + yClickRatio);
                fetch(`/forceDetection/${xClickRatio}/${yClickRatio}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server is responding to detection. Response: " + response.text());
                    }
                    else{
                        console.log("Error while requesting forcing detection. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function toggleDelta(clicked){
                fetch(`/toggleDelta/${clicked}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server is changing shown image. Response: " + response.text());
                    }
                    else{
                        console.log("Error while requesting different image. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function toggleContours(clicked){
                fetch(`/toggleContours/${clicked}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server is changing shown image. Response: " + response.text());
                    }
                    else{
                        console.log("Error while requesting different image. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function enableDisableMotor(motorStr, enable){
                fetch(`/enableDisableMotor/${motorStr}/${enable}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server is enabling/disabling motor. Response: " + response.text());
                    }
                    else{
                        console.log("Error while requesting enable/disable of motor. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function enableDisableDCMotors(enable){
                fetch(`/enableDisableDCMotor/${enable}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server is enabling/disabling DC motors. Response: " + response.text());
                    }
                    else{
                        console.log("Error while requesting enable/disable of DC motors. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function spoolDCMotors(){
                fetch(`/spoolDCMotors`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server is spooling DC motors. Response: " + response.text());
                    }
                    else{
                        console.log("Error while requesting spooling of DC motors. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            function stopSpoolingDCMotors(){
                fetch(`/stopDCMotors`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.status == 200){
                        console.log("Server is stopping DC motors. Response: " + response.text());
                    }
                    else{
                        console.log("Error while requesting sstop of DC motors. Response: " + response.status);
                    }
                })
                .catch(error => {
                    console.error(error)
                })
            }

            //Server Sent Events
            const dataEventSource = new EventSource('/dataEventSoruce');
            dataEventSource.onmessage = function(event) {
                serverData.runMode = JSON.parse(event.data).moddingImage;
                serverData.streaming = JSON.parse(event.data).streaming;
                serverData.actOnDetection = JSON.parse(event.data).actOnDetection;
                updateStaticHTML();
            };
            dataEventSource.onerror = function() {
                console.error("EventSource failed.");
            };

            const newDetectEventSource = new EventSource('/detectNotifySource');
            newDetectEventSource.onmessage = function(event) {
                console.log("new detection");
                displayDetectImg();
            }
            newDetectEventSource.onerror = function() {
                console.error("EventSource failed");
            }

            const motorLocationSource = new EventSource('/motorLocation');
            motorLocationSource.onmessage = function(event){
                //Get values
                serverData.xStepperPosition = JSON.parse(event.data).xPosition;
                serverData.yStepperPosition = JSON.parse(event.data).yPosition;
                serverData.servoPosition = JSON.parse(event.data).servoPosition;
                //Update values on page
                servoController.updateData()
            }


            //Misc functions
            function drawCrosshair(canvasContext, xCenter, yCenter, length, color, width){
                console.log("drawing crosshair at: " + xCenter + ", " + yCenter)
                canvasContext.strokeStyle = color;
                canvasContext.lineWidth = width;
                
                canvasContext.beginPath()
                canvasContext.moveTo(xCenter - length/2, yCenter)
                canvasContext.lineTo(xCenter + length/2, yCenter)
                canvasContext.stroke();

                canvasContext.beginPath()
                canvasContext.moveTo(xCenter, yCenter - length/2)
                canvasContext.lineTo(xCenter, yCenter + length/2)
                canvasContext.stroke();
                console.log("finished drawing crosshair")
            }

            function updateStaticHTML(){
                if(serverData.streaming == true){
                    pageButtons.streamButton.innerHTML = "Stop Stream";
                    pageButtons.streamButton.onclick = stopStream;
                }
                else{
                    pageButtons.streamButton.innerHTML = "Start Stream";
                    pageButtons.streamButton.onclick = startStream;
                }
                if(serverData.runMode == true){
                    pageButtons.imageModButton.innerHTML = "Stop Detection";
                    pageButtons.imageModButton.onclick = stopImgMod;
                }
                else{
                    pageButtons.imageModButton.innerHTML = "Run Detection";
                    pageButtons.imageModButton.onclick = startImgMod;
                }
                if(serverData.actOnDetection == true){
                    pageButtons.actOnDetectionButton.innerHTML = "Disable Act on Detection";
                }
                else{
                    pageButtons.actOnDetectionButton.innerHTML = "Enable Act on Detection";
                }
            }


            //Embedded functions
            window.onload = function() {
                toggleMainPage();
        }
        </script>
    </body>
</html>